<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Softuni Wizard Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="game">
    <div class="game-start">Press To Play</div>
    <div class="game-play">
        <div class="game-score">1200</div>
    </div>
    <div class="game-over"></div>
</div>

<script>

    // Getting referencess for the game components from the DOM
    const gameStart = getElement( ".game-start" ), 
        gamePlay = getElement( '.game-play' ), 
        gameOver = getElement( '.game-over' ), 
        gameScore = getElement( '.score' ); 

    // Game related events catching
    gameStart.addEventListener( 'click', start ); 
    document.addEventListener( 'keydown', onKeyDown );
    document.addEventListener( 'keyup', onKeyUp ); 

    const keys = {};
    const game = { 
        areaWidth: gamePlay.offsetWidth, 
        areaHeight: gamePlay.offsetHeight, 
        baseSpeed: 10, 
        multiplier: 1, 
        gravity: 5, 
        speed: function() { 
            return this.baseSpeed * this.multiplier; 
        }
    }; 
    const player = ( function() { 
        // Creating the main character 
        const wizard = buildEntity( [ 'wizard' ] );  
        // Inserting the main character in the DOM
        insertEntity( wizard, gamePlay ); 
        
        const width = wizard.offsetWidth, 
            height = wizard.offsetHeight, 
            gravityMultiplier = 1, 
            gravity = gravityMultiplier * game.gravity; 

        let left = getCSSValue( wizard, 'left' ), 
            bottom = getCSSValue( wizard, 'bottom' ); 


        // A change in the value of the property in this object
        // is reflected with change in the value of the property in the DOM
        function setBottom( value ) { 
            bottom = value; 
            changePosition( 'bottom', bottom ); 
        }

        function setLeft( value ) { 
            left = value; 
            changePosition( 'left', left );
        }


        // Assigns new value to the corresponding property of the DOM element
        function changePosition( position, value ) { 
            wizard.style[ position ] = assignPixelValue( value );
        }


        // Functions to modify the value of a position property
        // and pass it to the DOM

        function moveLeft() { 
            if ( isAtLeftBorder() ) { 
                return;
            } 
            setLeft( left - Math.min( left, game.speed() ) );
        }
        function moveUp() { 
            if ( isAtTopBorder() ) {
                return;
            }
            setBottom( bottom + Math.min( getTop(), game.speed() ) ); 
        }
        function moveRight() { 
            if ( isAtRightBorder() ) {
                return;
            }
            setLeft( left + Math.min( getRight(), game.speed() ) );
        }
        function moveDown() { 
            if ( isAtBottomBorder() ) {
                return;
            }
            setBottom( bottom - Math.min( bottom, game.speed() ) ); 
        }


        // Inner functions for checking wether 
        // the element has reached the end of the screen

        function isAtLeftBorder() { 
            return left <= 0;
        } 

        function isAtTopBorder() {
            return bottom > game.areaHeight - height; 
        }

        function isAtRightBorder() {
            return left >= game.areaWidth - width - 10; 
        }

        function isAtBottomBorder() { 
            return bottom <= 0; 
        }


        // Function that simulates the effect of gravity on the character
        function applyGravity() { 
            if ( isAtBottomBorder() ) { 
                return;
            }
            bottom -= gravity; 
            wizard.style.bottom = assignPixelValue( bottom ); 
        }


        // Getters, calculating the values of the properties, non directly used for positioning
        function getTop() { 
            return game.areaHeight - bottom - height;
        }

        function getRight() { 
            return game.areaWidth - left - width; 
        }


        return {
            moveLeft, 
            moveUp, 
            moveRight, 
            moveDown, 
            applyGravity 
        }; 
    }() ); 

    // Starts the gameplay
    function start() { 
        // Hiding the start button after click 
        hide( gameStart ); 

        // Starting the game loop
        requestAnimationFrame( gameMove ); 

    }

    function gameMove() { 
        player.applyGravity(); 

        if ( keys.ArrowLeft ) { 
            player.moveLeft(); 
        }
        if ( keys.ArrowUp ) { 
            player.moveUp(); 
        }
        if ( keys.ArrowRight ) { 
            player.moveRight(); 
        }
        if ( keys.ArrowDown ) { 
            player.moveDown();  
        } 

        requestAnimationFrame( gameMove ); 
    }

    function assignPixelValue( value ) { 
        return value + 'px';
    }

    function getCSSValue( element, property ) { 
        const valueString = getComputedStyle( element ).getPropertyValue( property );
        if ( valueString === 'auto' ) { 
            return 'auto';
        }
        return parseInt( valueString ); 
    }

    function onKeyUp( e ) { 
        keys[ e.code ] = false; 
    }

    function onKeyDown( e ) {
        keys[ e.code ] = true; 
    }

    // Appends newly created element to the provided wrapper
    function insertEntity( entity, wrapper ) { 
        wrapper.appendChild( entity ); 
    }

    // Creates an element with the provided class name and returns it 
    function buildEntity( classNames ) { 
        const character = document.createElement( 'div' );
        character.classList.add( ...classNames ); 
        return character;
    }

    // Hides an element 
    function hide( element ) { 
        element.classList.add( 'hidden' ); 
    }

    // Gets a ref to a DOM element
    function getElement( selector ) { 
        return document.querySelector( selector ); 
    }

</script>
    
</body>
</html>